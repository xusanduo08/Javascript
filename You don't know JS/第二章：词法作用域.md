### 你不知道的JS：作用域和闭包

### 第二章：词法作用域

在第一章，我们将作用域定义为一些列控制引擎如何通过标识符在当前作用域或者任何包含它的嵌套作用域中查找变量的规则。

关于作用域的工作目前有两种比较流行的模型。第一个也是目前为止最流行的，大多数语言用的也都是这个模型，叫做**词法作用域**，我们后面将会仔细研究这个。另一个模型，也有一些语言（比如Bash脚本，Perl中的一些模式等等）在使用，叫做**动态作用域**。

动态作用域会在附录A中有所讲解，在这里我们将其作为和词法作用域的一个对比。JavaScript中使用的就是词法作用域。

#### 词法分析

我们在第一章讨论过，标准语言的编译器工作语言的第一步叫做词法分析（或者说分词）。回想一下，词法分析会检测源码中的字符串。作为一些状态分析的结果，词法分析会赋予tokens以语法意义。

上面的概念提供了理解什么是词法作用域以及命名由来的基础。

词法作用域的定义有些绕，词法作用域是指在词法分析阶段定义的作用域。换句话说，词法作用域取决于你将变量和块级作用域写在何处，因此，在词法分析器分析代码的过程中，作用域是固定不变的（大多数情况下）。

**注意**：后面我们将介绍几种欺骗词法作用域的方法，这些方法可以在词法分析阶段之后修改词法作用域，但它们都有一些难理解。~~比较推崇的做法是仅在词法阶段也就是代码编写阶段定义词法作用域~~保持词法作用域与书写时的词法关系一致是一个比较推崇的做法。

看下面一段代码：

```javascript
function foo(a){
  var b = a * 2;
  function bar(c){
    console.log(a, b, c);
  }
  bar(b * 3);
}
foo(2); // 2 4 12
```

上面代码中有三层嵌套作用域。来将它们想象成相互包含的气泡：

![](./img/201910052203.png)

**气泡1**：包含全局作用域，其中只有一个标识符：`foo`。

**气泡2**：包含`foo`作用域，其中含有三个标识符：`a`、`bar`和`b`。

**气泡3**：包含`bar`作用域，其中只有一个标识符：`c`。

作用域气泡由各自作用域块被编写的位置所定义，这些作用域块之间~~相互~~逐级嵌套。下一章我们将会讨论~~不同的作用域~~作用域的不同组成，但目前我们仅假设每个函数会创建一个新的作用域气泡。

`bar`的作用域气泡完全被`foo`的作用域气泡所包含，因为（仅因为）我们就是在`foo`里定义的函数`bar`。

注意到这些嵌套气泡是被严格嵌套的。我们没有讨论气泡可以跨域边界的文恩图（Venn diagrams）。换句话说，作用域气泡不可能同时（部分）存在于两个外层作用域气泡中，就像没有函数可以部分的同时存在于两个父级函数中。















原文地址：<https://github.com/getify/You-Dont-Know-JS/blob/1st-ed/scope%20%26%20closures/ch2.md>